<html>
<head>
<meta charset="utf-8">
<title>Hello OpenCV.js</title>
</head>
<body>
<h2>OpenCV sample</h2>
<p id="status">OpenCV.js is loading...</p>
<div>
  <form name="test">
    <input type="button" value="Start" onClick="start()">
    <input type="button" value="Stop" onClick="stop()">
  </form>
  <div class="inputoutput">
    <video id="videoInput" width="640" height="480" ></video>
    <canvas id="canvasOutput" ></canvas>
  </div>
  </div>
  <br>
  <br>
</div>
<script type="text/javascript">
const FPS = 30;
let localStream = null;
let src = null;
let dst = null;
let cap = null;
let roi = null;
let work0 = null;
let labels = null;

function binalize(src) {
  work0 = src.roi(roi);
  cv.cvtColor(work0, work0, cv.COLOR_RGBA2RGB, 0);
  cv.cvtColor(work0, work0, cv.COLOR_RGB2HLS, 0);

  work0.convertTo(work0, cv.CV_32F);
  let buffer = []
  for (let y = 0; y < work0.rows; ++y) {
    buffer = buffer.concat(Array.from(work0.row(y).floatPtr(0)))
  }
  let vec = cv.matFromArray(work0.rows*work0.cols, 1, cv.CV_32FC3, buffer);
  let criteria = new cv.TermCriteria(cv.TermCriteria_EPS + cv.TermCriteria_MAX_ITER, 10, 1);
  let labels = new cv.Mat();
  cv.kmeans(vec, 2, labels, criteria, 1, cv.KMEANS_PP_CENTERS);
  vec.delete();
 buffer = [];
 for (let i = 0; i < labels.rows; ++i) {
   buffer.push(labels.intAt(i) * 255);
 }
 labels.delete();
 return cv.matFromArray(work0.rows, work0.cols, cv.CV_8UC1, buffer);
}

function processVideo() {
    try {
        let begin = Date.now();
        // start processing.
       cap.read(src);
       dst = binalize(src);
       cv.imshow('canvasOutput', dst);
        // schedule the next one.
        let delay = 1000/FPS - (Date.now() - begin);
        setTimeout(processVideo, delay);
        dst.delete();
    } catch (err) {
        console.error(err);
    }
};

function initialize() {
 let video = document.getElementById('videoInput');
 
  src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
 dst = new cv.Mat(video.height, video.width, cv.CV_8UC1);
 roi = new cv.Rect(video.width/2 - video.width/4, video.height/2 - video.height/4,
   video.width/2, video.height/2);
}

function start() {
  let video = document.getElementById("videoInput");
  navigator.mediaDevices.getUserMedia({video: true, audio: false})
    .then(function(stream) {
      video.srcObject = stream;
      video.play();
      localStream = stream;
      cap = new cv.VideoCapture(video);
      setTimeout(processVideo, 0);
  });
}

function stop() {
  localStream.getVideoTracks()[0].stop();
  cap = null;
}

function onOpenCvReady() {
  cv['onRuntimeInitialized'] = () => {
    document.getElementById('status').innerHTML = 'OpenCV.js is ready.';
    initialize();
  }
}



</script>
<script async src="./opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
</body>
</html>
