<html>
<head>
<meta charset="utf-8">
<title>Hello OpenCV.js</title>
</head>
<body>
<h2>OpenCV sample</h2>
<p id="status">OpenCV.js is loading...</p>
<div>
  <form name="test">
    <input type="button" value="Start" onClick="start()">
    <input type="button" value="Stop" onClick="stop()">
    <input type="button" value="Capture" onClick="captureFont()">
  </form>
  <div class="inputoutput">
    <video id="videoInput" width="640" height="480" ></video>
    <canvas id="canvasOutput" ></canvas>
  </div>
  </div>
  <br>
  <br>
</div>
<script type="text/javascript">
const FPS = 30;
let localStream = null;
let src = null;
let dst = null;
let cap = null;
let roi = null;
let work0 = null;
let labels = null;

function binalize(src) {
  let work = src.roi(roi);
  dst = new cv.Mat();
  cv.kmeansThresholding(work, dst);
  work.delete();
  return dst;
}

/*
function processVideo() {
    try {
        let begin = Date.now();
        // start processing.
       //cap.read(src);
       //dst = binalize(src);
       //cv.imshow('canvasOutput', dst);
        // schedule the next one.
        let delay = 1000/FPS - (Date.now() - begin);
        setTimeout(processVideo, delay);
        //dst.delete();
    } catch (err) {
        console.error(err);
    }
};
*/

function initialize() {
 let video = document.getElementById('videoInput');
 src = new cv.Mat(video.height, video.width, cv.CV_8UC4);
 dst = new cv.Mat(video.height, video.width, cv.CV_8UC1);
 roi = new cv.Rect(video.width/2 - video.width/4, video.height/2 - video.height/4,
   video.width/2, video.height/2);

   video.addEventListener('click', captureFont);
}

function start() {
  let video = document.getElementById("videoInput");
  navigator.mediaDevices.getUserMedia({video: {facingMode:'environment'}, audio: false})
    .then(function(stream) {
      video.srcObject = stream;
      video.play();
      localStream = stream;
      cap = new cv.VideoCapture(video);
      //setTimeout(processVideo, 0);
  });
}

function stop() {
  localStream.getVideoTracks()[0].stop();
  cap = null;
}

function captureFont() {
  cap.read(src);
  dst = binalize(src);
  cv.imshow('canvasOutput', dst);
  dst.delete();
}

function onOpenCvReady() {
  cv['onRuntimeInitialized'] = () => {
    document.getElementById('status').innerHTML = 'OpenCV.js is ready.';
    initialize();
  }
}



</script>
<script async src="./opencv.js" onload="onOpenCvReady();" type="text/javascript"></script>
</body>
</html>
